import streamlit as st
import pandas as pd
import plotly.express as px
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
import numpy as np
import openai

# ====== Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ OpenAI ======
openai.api_key = 'YOUR_OPENAI_API_KEY'

# ====== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© ======
language = st.sidebar.selectbox('Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ© / Select Language', ['Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'English'])

# ====== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ======
if language == 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©':
    st.set_page_config(page_title='Ù…Ù†ØµØ© ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„', layout='wide')
    st.title('Ù…Ù†ØµØ© ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„')
    st.write('Ù…Ù†ØµØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ØŒ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©ØŒ ÙˆØ§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ')
    upload_text = 'Ø§Ø®ØªØ± Ù…Ù„Ù CSV Ø£Ùˆ Excel'
    preview_text = 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'
    descriptive_text = 'Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©'
    charts_text = 'Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©'
    prediction_text = 'ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©'
    chatbot_text = 'Ø´Ø§Øª Ø¨ÙˆØª ØªÙØ§Ø¹Ù„ÙŠ'
    question_text = 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ø·Ù„Ø¨ Ù†ØµØ§Ø¦Ø­ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:'
    info_text = 'ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª CSV Ø£Ùˆ Excel Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª.'
else:
    st.set_page_config(page_title='Smart Analytics Hub', layout='wide')
    st.title('Smart Analytics Hub')
    st.write('Integrated platform for business analytics, predictive analysis, and smart chatbot')
    upload_text = 'Upload CSV or Excel file'
    preview_text = 'Data Preview'
    descriptive_text = 'Descriptive Analysis'
    charts_text = 'Charts'
    prediction_text = 'Future Sales Prediction'
    chatbot_text = 'Interactive Chatbot'
    question_text = 'Ask a question about the data or request business advice:'
    info_text = 'Please upload a CSV or Excel file to start analysis.'

# ====== Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ======
st.sidebar.header(upload_text)
data_file = st.sidebar.file_uploader(upload_text, type=['csv','xlsx'])

if data_file:
    if data_file.name.endswith('.csv'):
        df = pd.read_csv(data_file)
    else:
        df = pd.read_excel(data_file)

    st.subheader(preview_text)
    st.dataframe(df.head())

    # ====== Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ© ======
    st.subheader(descriptive_text)
    numeric_cols = df.select_dtypes(include=np.number).columns.tolist()
    for col in numeric_cols:
        st.write(f'**{col}**')
        st.write(df[col].describe())

    # ====== Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ======
    st.subheader(charts_text)
    col_x = st.selectbox('X Axis / Ø§Ù„Ù…Ø­ÙˆØ± X', numeric_cols)
    col_y = st.selectbox('Y Axis / Ø§Ù„Ù…Ø­ÙˆØ± Y', numeric_cols)
    fig = px.scatter(df, x=col_x, y=col_y, title=f'{col_x} vs {col_y}')
    st.plotly_chart(fig, use_container_width=True)

    # ====== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙ†Ø¨Ø¤ ======
    st.subheader(prediction_text)
    target_col = st.selectbox('Choose target column / Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù„Ù„ØªÙˆÙ‚Ø¹', numeric_cols, index=0)
    features = [col for col in numeric_cols if col != target_col]

    if features:
        X = df[features]
        y = df[target_col]
        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
        model = LinearRegression()
        model.fit(X_train, y_train)
        predictions = model.predict(X_test)

        st.write('First 10 predictions / Ø£ÙˆÙ„ 10 ØªÙˆÙ‚Ø¹Ø§Øª:', predictions[:10])
        fig_pred = px.line(x=range(len(y_test)), y=[y_test.tolist(), predictions.tolist()], labels={'x':'Sample / Ø§Ù„Ø¹ÙŠÙ†Ø©','y':'Value / Ø§Ù„Ù‚ÙŠÙ…Ø©'}, title='Actual vs Predictions / Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª')
        fig_pred.data[0].name = 'Actual / Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©'
        fig_pred.data[1].name = 'Prediction / Ø§Ù„ØªÙˆÙ‚Ø¹'
        st.plotly_chart(fig_pred, use_container_width=True)

    # ====== Ø´Ø§Øª Ø¨ÙˆØª ØªÙØ§Ø¹Ù„ÙŠ ======
    st.subheader(chatbot_text)
    user_question = st.text_input(question_text)

    if user_question:
        prompt = f"Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø§Ù„. Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {df.head().to_dict()}. Ø§Ù„Ø¢Ù† Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆØ¹Ù…Ù„ÙŠØ©: {user_question}"
        response = openai.Completion.create(
            engine='text-davinci-003',
            prompt=prompt,
            max_tokens=300,
            temperature=0.7
        )
        answer = response['choices'][0]['text']
        st.write('ğŸ’¡ Chatbot / Ø´Ø§Øª Ø¨ÙˆØª:', answer)

else:
    st.info(info_text)